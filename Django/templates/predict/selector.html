{% extends 'base.html' %}
{% load static %}

{% block title %}Select Cryptocurrency - CryptoSight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/selector.css' %}?v=8">
{% endblock %}

{% block content %}
<div class="selector-container">
    <div class="selector-header">
        <h1 class="selector-title">Select Cryptocurrency & Timeframe</h1>
        <p class="selector-subtitle">
            Choose your preferred cryptocurrency and prediction timeframe to get AI-powered price predictions
        </p>
    </div>
    
    <div class="selection-panels">
        <!-- Cryptocurrency Selection Panel -->
        <div class="crypto-panel">
            <h2 class="panel-title">
                <i class="fas fa-coins"></i>
                Select Cryptocurrency
            </h2>
            <div class="crypto-grid">
                {% for crypto in available_cryptos %}
                <div class="crypto-card" data-crypto="{{ crypto.symbol }}" onclick="selectCrypto('{{ crypto.symbol }}')">
                    <div class="crypto-icon-img">
                        <img src="{% static 'images/' %}{{ crypto.symbol|lower }}.svg" alt="{{ crypto.name }}" onerror="this.style.display='none'">
                    </div>
                    <h4>{{ crypto.name }}</h4>
                    <p class="crypto-symbol">{{ crypto.symbol }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Timeframe Selection Panel -->
        <div class="timeframe-panel">
            <h2 class="panel-title">
                <i class="fas fa-clock"></i>
                Prediction Timeframe
            </h2>
            
            <!-- Timeframe Tabs -->
            <div class="timeframe-tabs">
                <div class="timeframe-tab active" onclick="switchTimeframe('hourly')">
                    Hourly Prediction
                </div>
                <div class="timeframe-tab" onclick="switchTimeframe('daily')">
                    Daily Prediction
                </div>
            </div>
            
            <!-- Hourly Options -->
            <div class="timeframe-options-container">
                <div class="timeframe-grid hourly-timeframes" id="hourly-grid">
                    <!-- Hours 1-23 will be generated by JavaScript -->
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn prev-btn" onclick="changePage('hourly', -1)" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="page-indicator" id="hourly-page-indicator">Page 1 of 3</span>
                    <button class="pagination-btn next-btn" onclick="changePage('hourly', 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Daily Options (Hidden by default) -->
            <div class="timeframe-options-container" style="display: none;">
                <div class="timeframe-grid daily-timeframes" id="daily-grid">
                    <!-- Days 1-30 will be generated by JavaScript -->
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn prev-btn" onclick="changePage('daily', -1)" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="page-indicator" id="daily-page-indicator">Page 1 of 3</span>
                    <button class="pagination-btn next-btn" onclick="changePage('daily', 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Start Prediction Button -->
    <div class="predict-button-container">
        <button class="predict-btn" id="predictBtn" onclick="startPrediction()" disabled>
            <i class="fas fa-rocket"></i>
            START PREDICTION
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedCrypto = null;
let selectedTimeframe = null;
let selectedPeriod = null;

// Pagination state
const pagination = {
    hourly: { currentPage: 0, itemsPerPage: 10, totalItems: 23 },
    daily: { currentPage: 0, itemsPerPage: 10, totalItems: 30 }
};

// Initialize timeframe options on page load
document.addEventListener('DOMContentLoaded', function() {
    generateTimeframeOptions('hourly');
    generateTimeframeOptions('daily');
});

function generateTimeframeOptions(type) {
    const grid = document.getElementById(`${type}-grid`);
    const totalItems = type === 'hourly' ? 23 : 30;
    const label = type === 'hourly' ? 'Hour' : 'Day';
    
    grid.innerHTML = '';
    
    for (let i = 1; i <= totalItems; i++) {
        const card = document.createElement('div');
        card.className = 'timeframe-card';
        card.setAttribute('data-timeframe', type);
        card.setAttribute('data-period', i);
        card.setAttribute('data-page', Math.floor((i - 1) / 10));
        card.onclick = function() { selectTimeframe(type, i); };
        
        const hourText = i === 1 ? `${i} ${label}` : `${i} ${label}s`;
        
        // Use consistent icons: clock for hours, calendar for days
        const iconHTML = type === 'hourly' 
            ? '<i class="fa-solid fa-clock"></i>'
            : '<i class="fa-solid fa-calendar-days"></i>';
        
        card.innerHTML = `
            <div class="timeframe-icon">
                ${iconHTML}
            </div>
            <h4>Next ${hourText}</h4>
        `;
        
        grid.appendChild(card);
    }
    
    // Show first page
    showPage(type, 0);
}

function showPage(type, pageIndex) {
    const state = pagination[type];
    const cards = document.querySelectorAll(`#${type}-grid .timeframe-card`);
    
    // Hide all cards
    cards.forEach(card => {
        card.style.display = 'none';
    });
    
    // Show cards for current page
    const startIndex = pageIndex * state.itemsPerPage;
    const endIndex = Math.min(startIndex + state.itemsPerPage, state.totalItems);
    
    for (let i = startIndex; i < endIndex; i++) {
        if (cards[i]) {
            cards[i].style.display = 'block';
        }
    }
    
    // Update pagination controls
    updatePaginationControls(type, pageIndex);
}

function updatePaginationControls(type, pageIndex) {
    const state = pagination[type];
    const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
    
    // Update page indicator
    const indicator = document.getElementById(`${type}-page-indicator`);
    indicator.textContent = `Page ${pageIndex + 1} of ${totalPages}`;
    
    // Update button states
    const container = indicator.closest('.timeframe-options-container');
    const prevBtn = container.querySelector('.prev-btn');
    const nextBtn = container.querySelector('.next-btn');
    
    prevBtn.disabled = pageIndex === 0;
    nextBtn.disabled = pageIndex === totalPages - 1;
}

function changePage(type, direction) {
    const state = pagination[type];
    const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
    
    let newPage = state.currentPage + direction;
    
    // Clamp to valid range
    if (newPage < 0) newPage = 0;
    if (newPage >= totalPages) newPage = totalPages - 1;
    
    state.currentPage = newPage;
    showPage(type, newPage);
}

function selectCrypto(crypto) {
    selectedCrypto = crypto;
    
    // Remove selected class from all crypto cards
    document.querySelectorAll('.crypto-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    event.currentTarget.classList.add('selected');
    
    // Enable button if timeframe is also selected
    updatePredictButton();
}

function switchTimeframe(type) {
    // Update tab active state
    document.querySelectorAll('.timeframe-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Show/hide timeframe options containers
    const containers = document.querySelectorAll('.timeframe-options-container');
    if (type === 'hourly') {
        containers[0].style.display = 'block';
        containers[1].style.display = 'none';
    } else {
        containers[0].style.display = 'none';
        containers[1].style.display = 'block';
    }
    
    // Clear previous selection
    document.querySelectorAll('.timeframe-card').forEach(card => {
        card.classList.remove('selected');
    });
    selectedTimeframe = null;
    selectedPeriod = null;
    updatePredictButton();
}

function selectTimeframe(timeframe, period) {
    selectedTimeframe = timeframe;
    selectedPeriod = period;
    
    // Remove selected class from all timeframe cards
    document.querySelectorAll('.timeframe-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    event.currentTarget.classList.add('selected');
    
    // Enable button if crypto is also selected
    updatePredictButton();
}

function updatePredictButton() {
    const btn = document.getElementById('predictBtn');
    if (selectedCrypto && selectedTimeframe && selectedPeriod) {
        btn.disabled = false;
    } else {
        btn.disabled = true;
    }
}

function startPrediction() {
    console.log('Start Prediction clicked');
    console.log('Selected:', selectedCrypto, selectedTimeframe, selectedPeriod);
    
    if (!selectedCrypto || !selectedTimeframe || !selectedPeriod) {
        alert('Please select both cryptocurrency and timeframe');
        return;
    }
    
    // Redirect to processing page
    window.location.href = `/predict/processing/?crypto=${selectedCrypto}&timeframe=${selectedTimeframe}&period=${selectedPeriod}`;
}
</script>
{% endblock %}
